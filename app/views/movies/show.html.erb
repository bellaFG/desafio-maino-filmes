<div class="movie-card">
  <div class="movie-header">
    <h2 class="movie-title"><%= @movie.title %></h2>
  </div>

  <div class="movie-content">
    <% if @movie.poster.attached? %>
      <div class="poster">
        <%= image_tag poster_variant(@movie.poster), class: "poster-img" %>
      </div>
    <% end %>

    <div class="movie-info">
      <div class="details">
        <p>
          <strong><%= t('movies.show.director') %>:</strong> <%= @movie.director %>
        </p>
        <p>
          <strong><%= t('movies.show.year') %>:</strong> <%= @movie.year %>
        </p>
        <p>
          <strong><%= t('movies.show.duration') %>:</strong> <%= @movie.duration %> min
        </p>
      </div>

      <div class="synopsis">
        <p><%= @movie.synopsis %></p>
      </div>

      <div class="categories">
        <p>
          <strong><%= t('movies.show.categories') %>:</strong>
          <%= @movie.categories.pluck(:name).join(", ") %>
        </p>
      </div>

      <div class="tags">
        <p>
          <strong><%= t('movies.show.tags') %>:</strong>
          <% if @movie.tags.any? %>
            <% @movie.tags.each do |tag| %>
              <span class="tag"><%= tag.name %></span>
            <% end %>
          <% else %>
            <span class="tag tag--empty"><%= t('movies.show.no_tags') %></span>
          <% end %>
        </p>
      </div>
    </div>
  </div>

  <% if user_signed_in? && @movie.user == current_user %>
    <div class="actions">
      <%= link_to t('movies.show.edit'), edit_movie_path(@movie), class: "btn btn--secondary" %>
      <%= button_to t('movies.show.delete'), movie_path(@movie), method: :delete, data: { confirm: t('movies.show.confirm_delete') }, class: "btn btn--danger" %>
    </div>
  <% end %>
</div>

<div class="comments-section">
  <h3 class="comments-title"><%= t('movies.show.comments') %></h3>

  <% if @comments.any? %>
    <% @comments.each do |comment| %>
      <div class="comment-card">
        <p>
          <strong>
            <%= comment.user ? comment.user.name : comment.name.presence || t('movies.show.anonymous') %>:
          </strong>
          <%= comment.content %>
        </p>

        <% if (comment.user.present? && comment.user == current_user) || (comment.user.nil? && comment.anon_session_id.present? && cookies.signed[:anon_comment_id] == comment.anon_session_id) %>
          <div class="comment-actions">
            <%= link_to t('movies.show.edit'), edit_movie_comment_path(@movie, comment), class: "btn btn--secondary" %>
            <%= button_to t('movies.show.delete'), movie_comment_path(@movie, comment), method: :delete, data: { confirm: t('movies.show.confirm_delete') }, class: "btn btn--danger" %>
          </div>
        <% end %>
      </div>
    <% end %>
  <% else %>
    <p><%= t('movies.show.no_comments') %></p>
  <% end %>

  <div class="add-comment">
    <%= form_with(model: [@movie, Comment.new], local: true, class: "comment-form") do |f| %>
      <% unless user_signed_in? %>
        <div class="form-group">
          <%= f.label :name, t('movies.show.your_name'), class: "form-label" %>
          <%= f.text_field :name, class: "form-control", placeholder: t('movies.show.name_placeholder') %>
        </div>
      <% end %>

      <div class="form-group">
        <%= f.label :content, t('movies.show.add_comment'), class: "form-label" %>
        <%= f.text_area :content, rows: 3, class: "form-control", placeholder: t('movies.show.comment_placeholder') %>
      </div>

      <div class="form-actions">
        <%= f.submit t('movies.show.post_comment'), class: "btn btn--primary" %>
      </div>
    <% end %>
  </div>
</div>
