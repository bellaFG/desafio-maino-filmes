<%= form_with(model: @movie, local: true, html: { multipart: true }) do |f| %>
  <div class="form-group">
    <%= f.label :title, t('movies.form.title') %>
    <div class="title-ai-wrapper">
      <%= f.text_field :title, class: "form-control", id: "movie_title" %>
      <button type="button" id="fetch-movie" class="btn btn--secondary">
        ðŸ¤– <%= t('movies.form.fetch_ai') %>
      </button>
    </div>
  </div>

  <div class="form-group">
    <%= f.label :synopsis, t('movies.form.synopsis') %>
    <%= f.text_area :synopsis, rows: 4, class: "form-control", id: "movie_synopsis" %>
  </div>

  <div class="form-group">
    <%= f.label :year, t('movies.form.year') %>
    <%= f.number_field :year, class: "form-control", id: "movie_year" %>
  </div>

  <div class="form-group">
    <%= f.label :duration, t('movies.form.duration') %>
    <%= f.number_field :duration, class: "form-control", id: "movie_duration" %>
  </div>

  <div class="form-group">
    <%= f.label :director, t('movies.form.director') %>
    <%= f.text_field :director, class: "form-control", id: "movie_director" %>
  </div>

  <div class="form-group">
    <%= f.label :categories, t('movies.form.categories') %>
    <%= f.collection_check_boxes :category_ids, Category.all, :id, :name do |cb| %>
      <div class="form-check">
        <%= cb.check_box(class: "form-check-input") %>
        <%= cb.text %>
      </div>
    <% end %>
  </div>

  <div class="form-group">
    <%= f.label :tag_list, t('movies.form.tags') %>
    <%= f.text_field :tag_list, value: @movie.tags.pluck(:name).join(", "), class: "form-control" %>
  </div>

  <div class="form-group">
    <%= f.label :poster, t('movies.form.poster') %>
    <%= f.file_field :poster, class: "form-control" %>

    <% if @movie.poster.attached? %>
      <div class="poster-preview">
        <%= image_tag @movie.poster.variant(resize_to_limit: [200, 300]), class: "poster-preview__img" %>
        <div class="form-check">
          <%= f.check_box :remove_poster, class: "form-check-input" %>
          <%= f.label :remove_poster, t('movies.form.remove_poster'), class: "form-check-label" %>
        </div>
      </div>
    <% end %>
  </div>

  <div class="actions">
    <%= f.submit t('movies.form.submit'), class: "btn btn--primary" %>
  </div>
<% end %>

<!-- ðŸ”® Script: Busca de dados com IA -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const fetchBtn = document.getElementById("fetch-movie");
    if (!fetchBtn) return;

    fetchBtn.addEventListener("click", async () => {
      const title = document.getElementById("movie_title").value.trim();
      if (!title) {
        alert("Digite o tÃ­tulo do filme para buscar.");
        return;
      }

      fetchBtn.disabled = true;
      fetchBtn.textContent = "Buscando...";

      try {
        const response = await fetch(`/movies/fetch_movie_data?title=${encodeURIComponent(title)}`);
        const data = await response.json();

        if (data.error) {
          alert(data.error);
        } else {
          document.getElementById("movie_synopsis").value = data.synopsis || "";
          document.getElementById("movie_year").value = data.year || "";
          document.getElementById("movie_duration").value = data.duration || "";
          document.getElementById("movie_director").value = data.director || "";
        }
      } catch (error) {
        alert("Erro ao buscar dados do filme.");
      } finally {
        fetchBtn.disabled = false;
        fetchBtn.textContent = "ðŸ¤– Buscar com IA";
      }
    });
  });
</script>
